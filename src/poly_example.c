#ifdef NDEBUG
#undef NDEBUG
#endif

#include "poly.h"
#include "stack.h"
#include <assert.h>
#include <stdbool.h>
#include <stdarg.h>
#include <stdlib.h>
#include <stdio.h>
#include <malloc.h>

#define CHECK_PTR(p)  \
  do {                \
    if (p == NULL) {  \
      exit(1);        \
    }                 \
  } while (0)

#define C PolyFromCoeff

static Mono M(Poly p, poly_exp_t n) {
  return MonoFromPoly(&p, n);
}

static Poly MakePolyHelper(poly_exp_t dummy, ...) {
  va_list list;
  va_start(list, dummy);
  size_t count = 0;
  while (true) {
    va_arg(list, Poly);
    if (va_arg(list, poly_exp_t) < 0)
      break;
    count++;
  }
  va_start(list, dummy);
  Mono *arr = calloc(count, sizeof (Mono));
  CHECK_PTR(arr);
  for (size_t i = 0; i < count; ++i) {
    Poly p = va_arg(list, Poly);
    arr[i] = MonoFromPoly(&p, va_arg(list, poly_exp_t));
    assert(i == 0 || MonoGetExp(&arr[i]) > MonoGetExp(&arr[i - 1]));
  }
  va_end(list);
  Poly res = PolyAddMonos(count, arr);
  free(arr);
  return res;
}

#define P(...) MakePolyHelper(0, __VA_ARGS__, PolyZero(), -1)



int test() 
{
  Stack* stack = malloc(sizeof(Stack));
  stack->head = NULL;
  stack->size = 0;

  Poly p1 = P(P(C(1), 2), 0, P(C(1), 1), 1, C(1), 2);
  StackAdd(stack, &p1);

  Poly p2 = P(P(C(1), 2), 0, P(C(-1), 1), 1, C(1), 2);
  StackAdd(stack, &p2);

  Poly *p3 = StackPop(stack);
  Poly *p4 = StackPop(stack);
	Poly p5 = PolyMul(p3, p4);
  PolyDestroy(p3);
  PolyDestroy(p4);

  StackAdd(stack, &p5);

  Poly p6 = P(P(P(C(-3806074316380778664), 0, C(720799743446208), 16, C(1201332905743680), 20), 0, C(230655917902786560), 2, C(415180652225015808), 4, C(1107508805805098592), 7, C(900999679307760), 9, C(322918285063901184), 10, C(1621799422753968), 11, C(1261399551030864), 17), 3, C(-300333226435920), 5, P(P(C(-7107155503439257538), 0, C(-540599807584656), 16, C(-900999679307760), 20), 0, C(-173592604879961760), 2, C(-312466688783931168), 4, C(-830631604353823944), 7, C(-675749759480820), 9, C(-243029646831946464), 10, C(-1216349567065476), 11, C(-946049663273148), 17), 8, P(C(-1291868356852788084), 0, C(-1051166292525720), 2, C(-1892099326546296), 4, C(-1471632809536008), 10), 10, P(C(-369169601935032864), 0, C(-300333226435920), 2, C(-540599807584656), 4, C(-420466517010288), 10), 11, P(C(5168314360445172912), 0, C(4204665170102880), 2, C(7568397306185184), 4, C(5886531238144032), 10), 12, P(C(553754402902549296), 0, C(450499839653880), 2, C(810899711376984), 4, C(630699775515432), 10), 13, P(C(969070205079461268), 0, C(788374719394290), 2, C(1419074494909722), 4, C(1103724607152006), 10), 15, P(C(276877201451274648), 0, C(225249919826940), 2, C(405449855688492), 4, C(315349887757716), 10), 16, P(C(-3876235770333879684), 0, C(-3153498877577160), 2, C(-5676297979638888), 4, C(-4414898428608024), 10), 17);
  Poly p7 = P(P(P(P(P(C(360000000000000216), 9), 2, P(C(84), 9), 7, P(C(-540000000000000324), 9), 8, P(C(-126), 9), 13, C(76715683200), 16), 0, P(C(-76715683200), 16), 1, P(C(3350936073709551616), 16), 2, P(P(C(-12), 9), 2, P(C(18), 9), 8, C(-3350936073490988416), 16), 3, P(C(-218563200), 16), 4, P(C(-43008000136602000), 16), 5, P(C(5909912073846153616), 16), 6, P(C(-179096073682231216), 16), 7, P(C(-5687807942490558000), 16), 8, P(C(-41216000000000000), 16), 9, P(C(7182232073709551616), 16), 10, P(C(4723712000163922400), 16), 11, P(C(-4749920000000000000), 16), 12, P(C(-26656000102451500), 16), 13, P(C(9031800073709551616), 16), 14, P(C(4250400000020490300), 16), 15, P(C(-8400000000000000), 16), 16, P(C(-22512000000000000), 16), 17, P(C(13776000000000000), 16), 18, P(C(3553200000000000000), 16), 19, P(C(-7560000000000000), 16), 20, P(C(-3360000000000000), 16), 21, P(C(11592000000000000), 16), 22, P(C(-6300000000000000), 16), 24, P(C(1260000000000000), 16), 26), 0), 0, P(P(P(C(-1123200), 16), 0, P(C(1123200), 16), 1, P(C(-3200), 16), 3, P(C(3200), 16), 4, P(C(2000), 16), 5, P(C(-2000), 16), 6, P(C(-400), 16), 7, P(C(-842000), 16), 8, P(C(-2400), 16), 11, P(C(1500), 16), 13, P(C(-300), 16), 15), 0), 1, P(P(P(C(8985600), 16), 0, P(C(-8985600), 16), 1, P(C(25600), 16), 3, P(C(-25600), 16), 4, P(C(-16000), 16), 5, P(C(16000), 16), 6, P(C(3200), 16), 7, P(C(6736000), 16), 8, P(C(19200), 16), 11, P(C(-12000), 16), 13, P(C(2400), 16), 15), 0), 3, P(P(P(C(-5616000), 16), 0, P(C(5616000), 16), 1, P(C(-16000), 16), 3, P(C(16000), 16), 4, P(C(10000), 16), 5, P(C(-10000), 16), 6, P(C(-2000), 16), 7, P(C(-4210000), 16), 8, P(C(-12000), 16), 11, P(C(7500), 16), 13, P(C(-1500), 16), 15), 0), 6);
  Poly p8 = P(P(C(-11166464507310000), 0, C(-4581687622088756920), 2, C(973582274452138356), 3, C(-1298109699269517808), 5, C(324527424817379452), 7, C(-8247037719759762456), 8), 0, P(C(-6040738882977665388), 0, C(-1102247992879477920), 2, C(-151199999023248), 3, C(201599998697664), 5, C(-50399999674416), 7, C(-1984046387183060256), 8), 4, C(973582274452138356), 5, P(C(2268000), 0, C(183707998813246320), 2, C(25199999837208), 3, C(-33599999782944), 5, C(8399999945736), 7, C(330674397863843376), 8), 6, P(C(-11009977370052), 0, C(314927997965565120), 2, C(43199999720928), 3, C(-57599999627904), 5, C(14399999906976), 7, C(566870396338017216), 8), 8, C(-151199999023248), 9, P(C(2799999333912), 0, C(-52487999660927520), 2, C(-7199999953488), 3, C(9599999937984), 5, C(-2399999984496), 7, C(-94478399389669536), 8), 10, P(C(22718580776028), 0, C(1417175990845043040), 2, C(194399998744176), 3, C(-259199998325568), 5, C(64799999581392), 7, C(2550916783521077472), 8), 11, P(C(5391688833313722532), 0, C(-1259711991862260480), 2, C(-172799998883712), 3, C(230399998511616), 5, C(-57599999627904), 7, C(-2267481585352068864), 8), 12, P(C(43199996804928), 0, C(-236195998474173840), 2, C(-32399999790696), 3, C(43199999720928), 5, C(-10799999930232), 7, C(-425152797253512912), 8), 13, P(C(-799997404008), 0, C(209951998643710080), 2, C(28799999813952), 3, C(-38399999751936), 5, C(9599999937984), 7, C(377913597558678144), 8), 14, C(14399999903952), 15, C(-973289474454031860), 16, C(-176399998859952), 17, C(-48799999684416), 18, C(28799999805744), 19, C(117599999248368), 20, C(1368), 21, C(-19599999870840), 22, C(-151199999026704), 23, C(91199999410200), 24, C(25199999837784), 25, C(-15199999901808), 26, C(-194399998744176), 27, C(172799998883712), 28, C(32399999790696), 29, C(-28799999813952), 30);

  StackAdd(stack, &p6);
  StackAdd(stack, &p7);
  StackAdd(stack, &p8);

  Poly *p9 = StackPop(stack);
  Poly *p10 = StackPop(stack);

  Poly p11 = PolyMul(p9, p10);

  StackAdd(stack, &p11);

  PolyDestroy(p9);
  PolyDestroy(p10);
  StackFree(stack);
}
